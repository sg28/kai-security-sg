// src/components/vulnerability/VulnerabilityList.tsx
import { memo } from 'react';
import { List } from 'react-virtualized';
import { Checkbox } from '@mui/material';
import { Vulnerability } from '../../types/vulnerability';

interface VulnerabilityListProps {
  data: Vulnerability[];
  isLoading: boolean;
  onSelect?: (vulnerability: Vulnerability) => void;
  selectedVulnerabilities?: Vulnerability[];
  onToggleCompare?: (vulnerability: Vulnerability) => void;
}

const VulnerabilityRow = memo(
  ({ vulnerability, onClick, isChecked, onCheck }: {
    vulnerability: Vulnerability;
    onClick?: (v: Vulnerability) => void;
    isChecked?: boolean;
    onCheck?: (v: Vulnerability) => void;
  }) => {
    return (
      <div
        style={{ padding: '8px', borderBottom: '1px solid #eee', cursor: 'pointer', display: 'flex', alignItems: 'center' }}
        onClick={() => onClick?.(vulnerability)}
      >
        <Checkbox
          checked={Boolean(isChecked)}
          onClick={(e) => e.stopPropagation()}
          onChange={() => onCheck?.(vulnerability)}
        />
        <div>
          <strong>{vulnerability.cveId}</strong> - {vulnerability.severity} (Risk: {vulnerability.riskScore})
        </div>
      </div>
    );
  },
  (prev, next) =>
    prev.vulnerability.cveId === next.vulnerability.cveId &&
    prev.isChecked === next.isChecked
);

export function VulnerabilityList({
  data,
  isLoading,
  onSelect,
  selectedVulnerabilities = [],
  onToggleCompare
}: VulnerabilityListProps) {
  if (isLoading) {
    return <div>Loading vulnerabilities...</div>;
  }

  const filtered = data.filter(Boolean);

  if (!filtered.length) {
    return <div>No vulnerabilities found.</div>;
  }

  const rowRenderer = ({ index, key, style }: any) => {
    const vuln = filtered[index];
    const isChecked = selectedVulnerabilities.some(v => v.cveId === vuln.cveId);

    return (
      <div key={key} style={style}>
        <VulnerabilityRow
          vulnerability={vuln}
          onClick={onSelect}
          isChecked={isChecked}
          onCheck={onToggleCompare}
        />
      </div>
    );
  };

  return (
    <List
      width={1000}
      height={400}
      rowCount={filtered.length}
      rowHeight={50}
      rowRenderer={rowRenderer}
    />
  );
}
